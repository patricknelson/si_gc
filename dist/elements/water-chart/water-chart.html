<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<polymer-element name="water-chart"  attributes="num">
  <template>

    <style>
   :host {
        display: block;
        position: relative;
        top: 8px;
   }
   :host google-chart{
      top:-40px;
    }   

    .blue{color:#0064D2}
    .green{color:#86B817;}
    .grey{color:#796e65;}
    .lt-blue{color:#66A2E4;}
      .notChrome.top_label{top:96px;}
      /*.notChrome.top_label.upper{left:-40px}*/
      .notChrome.bottom_label{top:29%;left:27%;}
      .notChrome.bottom_label.lower{top:29%;}
      .top_label, .bottom_label{position:absolute;z-index: 99;width:100%;}
      
      .top_label{left: 92px;  top: 80px;}
      .bottom_label{left:28%; top:45%;color:#fff;}
      .bottom_label.chart5{top:23%; }
      .top_label>p, .bottom_label>p{position:absolute;font-size:18px;}

      .top_label>p.blue{left:-4px;top:-109px;}
      .bottom_label > p{font-size:16px;}
      .bottom_label > p:first-child{left:1%;z-index:0;}

      .top_label>p.green{left:22%;top:-55px;}
      .bottom_label > p:nth-child(2) {left:22%;}

      .top_label>p.lt-blue{left:44%;top:24px;}
      .bottom_label > p:last-child{left: 44.2%;}
      .water-loc.grey{margin-top:14px;font-size:15px;text-align:center;position:relative;top:-8em;}

      /** CHART 1 **/
      .top_label.chart1{top:84px;z-index:999;}
      .top_label.chart1.notChrome{top:100px;}
      .top_label.chart1>p.blue{top:-80px;}
      .top_label.chart1>p.green{top:-56px;}
      .top_label.chart1>p.lt-blue{  top: -32px;}
      .bottom_label.chart1{top:31%;}
      .notChrome.bottom_label.chart1{top:20.5%;}
      .chart1.water-loc.grey{  top: -11.4em;}

      /** CHART 2 **/
      .top_label.chart2{top:96px;}
      .notChrome.top_label.chart2{top:116px;}
      .top_label.chart2>p.green{top:-128px;}
      .top_label.chart2>p.lt-blue{top:-54px}
       .bottom_label.chart2{top:52%;}
       .bottom_label.chart2.notChrome{top:32.5%;}
       .chart2.water-loc.grey{ top: -6.6em;}
      
       /** CHART 3 */
      .notChrome.top_label.chart3{top:130px;}
      .top_label.chart3{top:112px;}
      .top_label.chart3>p.green{top:-60px;}
      .top_label.chart3>p.lt-blue{top:-30px;}
      .bottom_label.chart3{ top:46.3%;     }
       /** CHART 4 */

      .top_label.chart4{  top: 34px;}
      .notChrome.top_label.chart4{top:52px;}
      .top_label.chart4>p.blue{top:2px;}
      .top_label.chart4>p.green{top:15px;}
      .top_label.chart4>p.lt-blue{top:20px;}
      .bottom_label.chart4{top:28.5%;}
      .bottom_label.lower.notChrome.chart4{top:19.3%;}
      .chart4.water-loc.grey{  top: -11.9em;}
      /** CHART 5 */
      .top_label.chart5{top:60px;/*40px;*/}
      .notChrome.top_label.chart5{top:78px;}
      .top_label.chart5>p.blue{top:-1px;left:6px;z-index:99;}
      .top_label.chart5>p.green{top:-8px;}
      .top_label.chart5>p.lt-blue{top:-14px;/*-34px;*/}
      .bottom_label.lower.chart5{top:24.5%;}
      .bottom_label.lower.notChrome.chart5{top:16.8%;}
      .chart5.water-loc.grey{  top: -13em;}

      /**.top_label > p{color:red!important;}**/
      @media screen and (min-width:1025px) and (max-width:1349px){
        :host{  position: relative;  left: -16%;}
        .top_label > p.green{left: 23.8%; }
        .top_label > p.lt-blue{left: 47.6%;}
        .bottom_label > p:nth-child(2) {left: 26.6%;}   
        .bottom_label > p:nth-child(3) {left: 51.2%;}
      }

      @media screen and (max-width:1024px){  
        :host{left: -20%;}
        .bottom_label{left:60%;}
        .top_label>p.green {left: 31.6%;}
        .top_label>p.lt-blue {left: 62.6%;}
        .bottom_label > p:first-child {left: -55px;}
        .bottom_label > p:nth-child(2) {left: 10%;}
        .bottom_label > p:last-child {left: 109px;}
        .water-loc.grey {font-size: 14px;top: -8.4em;left: 5.3em;}
      }
      @media screen and (max-width: 1200px) and (orientation:portrait){
        :host {left: -39%;}
        .bottom_label.upper{left:22%;}
        .bottom_label{left:28%;}
         .top_label>p.green {left: 35.6%;}
        .top_label>p.lt-blue {left: 72.6%;}
        .top_label.upper>p.green{left:29.6%;} 
        .top_label.upper>p.lt-blue{left:57.6%;}
        .bottom_label > p:first-child {left: 37px;}
        .bottom_label > p:nth-child(2) {left: 116px;}
        .bottom_label > p:last-child {left: 196px}
        .water-loc.grey {font-size: 14px;top: -8.4em;left: 6.5em;}
      }

       @media only screen and (max-device-width: 667px){
        :host {left: -18%;}
        :host google-chart::before {content: "";height: 1px;background: #ccc;display: block;position: absolute;width: 110%;top: 154px;left: 20px;}
        .top_label{top: 80px;}
        .notChrome.top_label.upper > p.lt-blue,.notChrome.top_label.lower > p.lt-blue{left:58.6%;}
        .notChrome.upper.bottom_label > p:last-child,.notChrome.lower.bottom_label > p:last-child{left:70.2%;}
        .notChrome.upper.bottom_label > p:nth-child(2),.notChrome.lower.bottom_label > p:nth-child(2){left:39.6%;}

        .bottom_label{  top: 105px;}
        .notChrome.bottom_label.upper,.notChrome.bottom_label.lower{top:23%;}
        .bottom_label.lower{left:22%;}

        .top_label.chart1>p.blue{top:-115px;}
        .top_label.chart1>p.green {top: -64px;left:29.6%;}
        .top_label.upper.chart1>p.lt-blue{top:4px;}

        .notChrome.top_label.chart.upper1>p.green {left:29.6%;}
        .notChrome.top_label.upper.chart1>p.lt-blue{left:58.6%;}
        
        .top_label.chart2 {top: 92px;}
        .notChrome.top_label.chart2{top:104px;}
        .top_label.chart2>p.green {top: -126px;}
        .top_label.chart2>p.lt-blue {top: -12px!important;}
        

        .top_label.chart3{top:90px;}
        .top_label.chart3>p.blue{top:-118px;}
        .top_label.chart3>p.green {top: -62px;left:30.6%;}

        .top_label.chart4>p.blue{top:-114;}
        .top_label.chart4>p.green {top: -42px; left: 26.4%;}

        .top_label.chart5 {top: 5px;}
        .notChrome.top_label.chart5{top:20px;}
        .notChrome.bottom_label.lower {top:13%;}
        .top_label.chart5.lower>p.lt-blue{top:-12px;}
        .top_label.chart5>p.green{top:10px;left: 26.6%;}

        .top_label.upper>p.lt-blue,.top_label.lower>p.lt-blue {top:-4px;left: 52.6%;}
        .bottom_label > p:nth-child(2) {left: 36.6%;}
        .bottom_label > p:last-child {left: 63.2%;}
        .notChrome.upper.bottom_label > p:last-child,.notChrome.lower.bottom_label > p:last-child{left:70.2%;}
        .notChrome.upper.bottom_label > p:nth-child(2),.notChrome.lower.bottom_label > p:nth-child(2){left:39.6%;}
        .water-loc.grey {top: -11em;left: 3em;}
        .notChrome.water-loc.grey.lower{top:-14.5em;} 
      }
      @media screen and (device-aspect-ratio: 40/71) {
        :host {left: -28%;}
        :host google-chart::before {width:118%;left: 24px;}
        .top_label>p.green{left:29.6%!important;}
        .top_label.upper>p.lt-blue,.top_label.lower>p.lt-blue {top:-4px;left: 59.6%;}

        .bottom_label > p:nth-child(2) {left: 45.6%;}
        .bottom_label > p:last-child {left: 75.2%;}
        .water-loc.grey {top: -11em;left: 4.5em;}
      }
    </style>
     <core-ajax auto url="scripts/data/water{{num}}.json" handleAs="json" response="{{response}}"></core-ajax> 
     <div class="top_label {{cls}} chart{{num}} {{cls2}}"><p class="blue">{{vals[0]}}</p><p class="green">{{vals[1]}}</p><p class="lt-blue">{{vals[2]}}</p></div>
      <google-chart type="column" 
                    class="chart{{num}}"
                    id="water{{num}}" 
                    options='{{opts}}'
                    data='scripts/data/water{{num}}.json'>
       </google-chart>
       <div class="bottom_label chart{{num}} {{cls}} {{cls2}}"><p>2014</p><p>2013</p><p>2012</p></div>
       <div class="water-loc grey chart{{num}} {{cls}} {{cls2}}">{{locations[num]}}</div>
  </template>
  <script>
    (function(){
      Polymer({
          ready: function() {
            var self = this;
            this.id = 'water' + this.num;
            this.cls =  (this.num < 3) ? 'upper' : 'lower';
            this.cls2 =  (this.isNotChrome()) ? 'notChrome' : '';
            this.locations = {
              1:"Salt Lake City, Utah",
              2:"Pheonix, AZ",
              3:"San Jose North",
              4:"San Jose South",
              5:"Omaha"
           };
            var height = (this.isMobile()) ? 155 : 195;
            var caw    = (this.isMobile()) ? "65%" : "60%";
            var cah    = "130%";
            var max    = 60000;
            var min    = 0
            if(this.num == 5) {cah ="20%"; height: 120;max = 45000;}
            if(this.num == 4) {cah ="60%"; height = 165; max = 4500;}
            if(this.num == 3) {cah ="110%"; height = 190;max = 45000;}
            if(this.num == 2) {cah = "100%"; height = 210;}
            if(this.num == 1) {cah ="55%"; height = 180;}
            this.opts = {"width": 400,"height": height,"chartArea": {"width": caw, "height": cah},"bar": {"groupWidth": "90%"},"legend": {"position": "none" },"hAxis": { "textPosition": "none","gridlines": {"color": "transparent"},"baselineColor": 'transparent'},"vAxis": { "textPosition": "none","gridlines": {"color": "transparent"},"baselineColor": 'transparent'},"backgroundColor": { "fill":"transparent" },"viewWindowMode":"explicit","viewWindow":{"max":max,"min":min},"minValue": min, "maxValue": max,"annotations": {"alwaysOutside": true, "textStyle": {"fontSize": 18}},"animation":{"duration": 3000,"easing": "in"},"tooltip": {"trigger": "none"},"enableInteractivity" : false };
            var self = this;
          $(document).on('google-chart-render',function(e){
            var id = e.target.id;
            if(id === "water4"){
              setTimeout(function(){
                self.fixBarHeights();
              }, 1000);
            }else{
              return false;
            }
          });
          },
          fixBarHeights:function(){
             var bars = this.findChart().getChartSvg().querySelectorAll('g:first-of-type>g:first-child > rect');
              var incr = (this.cls2 == 'notChrome') ? 1:0;
              if(this.num == 5){this.setAllAttributes(bars[0],['height','y'],['16',100+incr]);}
              if(this.num == 4){
                this.setAllAttributes(bars[0],['height','y'],['52',78+incr]);
                this.setAllAttributes(bars[1],['height','y'],['39',91+incr]);
                this.setAllAttributes(bars[2],['height','y'],['34',96+incr]);
              }
              if(this.num == 1){
                this.setAllAttributes(bars[1],['height','y'],['70',69+incr]);
                this.setAllAttributes(bars[2],['height','y'],['46',93+incr]);
              }
              if(this.num == 2){this.setAllAttributes(bars[2],['height','y'],['126',86+incr]);}
              if(this.num == 3){this.setAllAttributes(bars[2],['height','y'],['64',124+incr]);}

          },
          setAllAttributes:function(el,attrs,avals){
            attrs.forEach(function(attr,i){
              el.setAttribute(attr,avals[i]);
            });
          },
          checkFixSafari:function(){
              if(this.isSafari()){
                $('#'+this.id).css('left','0px');
                
              }
          },
          isSafari:function(){
            return /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor) ? true : false;
          },
          isNotChrome:function(){
            return (!!window.chrome && !!window.chrome.webstore) ? false: true;
          },
          responseChanged: function(oldValue) {
            this.vals = [this.response[1][1],this.response[2][1],this.response[3][1]];
            this.formatNumbers(this.vals);
            if(this.num == 3) this.vals = ["44,659","38,877","32,740"];
            if(this.num == 4) this.vals = ["22,798","18,935","17,080"];
          },
          isMobile :function(){
            return window.matchMedia('screen and (max-width: 767px)').matches;
          },
          formatNumbers:function(data){
              var self = this;
              data.forEach(function(num,i){
                  self.vals[i] = num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
              });
          },
          findChart:function(id){
            //return document.getElementById(id)
            var id = (typeof id === 'undefined') ? this.id : 'water' + id;
            return this.$[id];
          }

      });
    })();
  </script>
</polymer-element>